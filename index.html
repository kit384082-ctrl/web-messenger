<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Messenger - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è</title>
    <style>
        /* –°–±—Ä–æ—Å –∏ –±–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow: hidden;
            user-select: none;
        }

        /* –ó–∞–≥—Ä—É–∑—á–∏–∫ */
        .loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.3s ease;
        }

        .loader-content {
            text-align: center;
            color: white;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* –û–∫–Ω–æ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–∞ */
        .messenger {
            width: 100%;
            max-width: 1200px;
            height: 90vh;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            display: flex;
            overflow: hidden;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.5s ease;
            position: relative;
        }

        .messenger.loaded {
            opacity: 1;
            transform: translateY(0);
        }

        /* –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å */
        .sidebar {
            width: 320px;
            background: #1a1d21;
            color: white;
            display: flex;
            flex-direction: column;
            border-right: 1px solid rgba(255,255,255,0.1);
            position: relative;
            z-index: 10;
        }

        /* –•–µ–¥–µ—Ä –ø—Ä–æ—Ñ–∏–ª—è */
        .profile-header {
            padding: 24px 20px;
            background: rgba(255,255,255,0.05);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .profile-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .profile-avatar:hover {
            transform: scale(1.05);
        }

        .profile-info {
            flex: 1;
            overflow: hidden;
        }

        .profile-name {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .profile-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: rgba(255,255,255,0.7);
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #2ecc71;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* –ü–æ–∏—Å–∫ */
        .search-container {
            padding: 16px 20px;
            position: relative;
        }

        .search-box {
            position: relative;
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255,255,255,0.5);
            font-size: 18px;
        }

        .search-input {
            width: 100%;
            padding: 12px 12px 12px 40px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 12px;
            color: white;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            background: rgba(255,255,255,0.15);
            border-color: #667eea;
        }

        .search-input::placeholder {
            color: rgba(255,255,255,0.5);
        }

        /* –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ */
        .chats-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px 0;
        }

        .chats-list::-webkit-scrollbar {
            width: 6px;
        }

        .chats-list::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
        }

        .chats-list::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.3);
            border-radius: 3px;
        }

        .chats-list::-webkit-scrollbar-thumb:hover {
            background: rgba(255,255,255,0.4);
        }

        .chat-item {
            display: flex;
            align-items: center;
            padding: 16px 20px;
            cursor: pointer;
            transition: background 0.2s ease;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            position: relative;
        }

        .chat-item:hover {
            background: rgba(255,255,255,0.05);
        }

        .chat-item.active {
            background: rgba(255,255,255,0.1);
        }

        .chat-item.unread::before {
            content: '';
            position: absolute;
            left: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 6px;
            height: 6px;
            background: #667eea;
            border-radius: 50%;
        }

        .chat-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .chat-info {
            flex: 1;
            min-width: 0;
        }

        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .chat-name {
            font-weight: 600;
            font-size: 15px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-time {
            font-size: 12px;
            color: rgba(255,255,255,0.5);
            flex-shrink: 0;
        }

        .chat-preview {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: rgba(255,255,255,0.7);
        }

        .chat-message {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
        }

        .chat-unread {
            background: #667eea;
            color: white;
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
            flex-shrink: 0;
        }

        /* –û—Å–Ω–æ–≤–Ω–æ–µ –æ–∫–Ω–æ —á–∞—Ç–∞ */
        .chat-window {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #0d1117;
            position: relative;
        }

        /* –®–∞–ø–∫–∞ —á–∞—Ç–∞ */
        .chat-header-bar {
            background: #1a1d21;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .chat-partner-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chat-partner-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .chat-partner-details h3 {
            font-size: 16px;
            color: white;
            margin-bottom: 2px;
        }

        .chat-partner-status {
            font-size: 13px;
            color: rgba(255,255,255,0.7);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .chat-actions {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .chat-action-btn {
            background: none;
            border: none;
            color: rgba(255,255,255,0.7);
            font-size: 20px;
            cursor: pointer;
            transition: color 0.2s ease;
            padding: 8px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chat-action-btn:hover {
            color: white;
            background: rgba(255,255,255,0.1);
        }

        /* –û–∫–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π */
        .messages-area {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            position: relative;
        }

        .messages-area::-webkit-scrollbar {
            width: 8px;
        }

        .messages-area::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.05);
            border-radius: 4px;
        }

        .messages-area::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.2);
            border-radius: 4px;
        }

        .messages-area::-webkit-scrollbar-thumb:hover {
            background: rgba(255,255,255,0.3);
        }

        .empty-chat {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: rgba(255,255,255,0.5);
            width: 80%;
        }

        .empty-chat-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-chat h3 {
            font-size: 18px;
            margin-bottom: 8px;
            color: rgba(255,255,255,0.8);
        }

        .empty-chat p {
            font-size: 14px;
            line-height: 1.5;
        }

        /* –°–æ–æ–±—â–µ–Ω–∏–µ */
        .message {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
            word-wrap: break-word;
            animation: messageAppear 0.3s ease;
            line-height: 1.4;
        }

        @keyframes messageAppear {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.outgoing {
            background: #667eea;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 6px;
        }

        .message.incoming {
            background: #2d3748;
            color: white;
            align-self: flex-start;
            border-bottom-left-radius: 6px;
        }

        .message-text {
            font-size: 14.5px;
            margin-bottom: 4px;
        }

        .message-time {
            font-size: 11px;
            opacity: 0.7;
            text-align: right;
            display: block;
        }

        .message-status {
            font-size: 12px;
            margin-left: 4px;
        }

        .message-status.read {
            color: #667eea;
        }

        /* –°–∏—Å—Ç–µ–º–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è */
        .system-message {
            text-align: center;
            margin: 16px 0;
            position: relative;
        }

        .system-message::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            width: 100%;
            height: 1px;
            background: rgba(255,255,255,0.1);
        }

        .system-message span {
            background: #1a1d21;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 13px;
            color: rgba(255,255,255,0.7);
            position: relative;
            z-index: 1;
        }

        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞–±–æ—Ä–∞ */
        .typing-indicator {
            padding: 0 24px 16px;
            font-size: 13px;
            color: rgba(255,255,255,0.7);
            font-style: italic;
            height: 20px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .typing-indicator:empty {
            height: 0;
            padding: 0;
        }

        /* –ü–æ–ª–µ –≤–≤–æ–¥–∞ */
        .input-container {
            padding: 20px 24px;
            background: #1a1d21;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .input-wrapper {
            display: flex;
            align-items: flex-end;
            gap: 12px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 24px;
            padding: 8px 20px;
            transition: border-color 0.3s ease;
        }

        .input-wrapper:focus-within {
            border-color: #667eea;
        }

        .message-input {
            flex: 1;
            background: none;
            border: none;
            color: white;
            font-size: 15px;
            padding: 10px 0;
            outline: none;
            resize: none;
            max-height: 120px;
            min-height: 40px;
            line-height: 1.4;
            font-family: inherit;
        }

        .message-input::placeholder {
            color: rgba(255,255,255,0.5);
        }

        .send-button {
            background: #667eea;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
            margin-bottom: 4px;
        }

        .send-button:hover:not(:disabled) {
            background: #5a6fd8;
            transform: scale(1.05);
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* –û–∫–Ω–æ –≤—Ö–æ–¥–∞ */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            transition: opacity 0.5s ease;
        }

        .login-container {
            width: 90%;
            max-width: 420px;
            background: white;
            border-radius: 24px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            transform: translateY(20px);
            animation: slideUp 0.5s ease forwards;
        }

        @keyframes slideUp {
            to {
                transform: translateY(0);
            }
        }

        .login-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .login-avatar {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            color: white;
            margin: 0 auto 20px;
        }

        .login-header h2 {
            color: #2d3748;
            margin-bottom: 8px;
            font-size: 24px;
        }

        .login-header p {
            color: #718096;
            font-size: 14px;
        }

        .login-form {
            margin-bottom: 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            color: #4a5568;
            font-size: 14px;
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 15px;
            transition: all 0.3s ease;
            background: white;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-input.error {
            border-color: #fc8181;
        }

        .error-message {
            color: #fc8181;
            font-size: 13px;
            margin-top: 6px;
            display: block;
        }

        .avatar-preview {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .avatar-preview .preview {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
            flex-shrink: 0;
        }

        .avatar-input {
            flex: 1;
        }

        .login-buttons {
            display: flex;
            gap: 12px;
        }

        .btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #f7fafc;
            color: #4a5568;
            border: 2px solid #e2e8f0;
        }

        .btn-secondary:hover {
            background: #edf2f7;
            border-color: #cbd5e0;
        }

        .login-footer {
            text-align: center;
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid #e2e8f0;
            color: #718096;
            font-size: 14px;
        }

        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 32px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .modal.active .modal-content {
            transform: scale(1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-title {
            font-size: 20px;
            color: #2d3748;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #718096;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: #f7fafc;
            color: #2d3748;
        }

        .modal-body {
            margin-bottom: 24px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
        .notification {
            position: fixed;
            top: 24px;
            right: 24px;
            background: white;
            border-radius: 12px;
            padding: 16px 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 9999;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            flex-shrink: 0;
        }

        .notification.success .notification-icon {
            background: #2ecc71;
            color: white;
        }

        .notification.error .notification-icon {
            background: #e74c3c;
            color: white;
        }

        .notification.info .notification-icon {
            background: #3498db;
            color: white;
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 4px;
        }

        .notification-message {
            font-size: 14px;
            color: #718096;
        }

        .notification-close {
            background: none;
            border: none;
            color: #718096;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .notification-close:hover {
            background: #f7fafc;
            color: #2d3748;
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 768px) {
            .messenger {
                flex-direction: column;
                height: 100vh;
                border-radius: 0;
                max-width: none;
            }
            
            .sidebar {
                width: 100%;
                height: 300px;
            }
            
            .chat-window {
                flex: 1;
            }
            
            .message {
                max-width: 85%;
            }
            
            .login-container {
                padding: 24px;
            }
            
            .login-buttons {
                flex-direction: column;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            
            .messages-area {
                padding: 16px;
            }
            
            .input-container {
                padding: 16px;
            }
            
            .chat-header-bar {
                padding: 12px 16px;
            }
        }

        /* –£—Ç–∏–ª–∏—Ç—ã */
        .hidden {
            display: none !important;
        }

        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
    </style>
</head>
<body>
    <!-- –ó–∞–≥—Ä—É–∑—á–∏–∫ -->
    <div class="loader" id="loader">
        <div class="loader-content">
            <div class="spinner"></div>
            <div>–ó–∞–≥—Ä—É–∑–∫–∞ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–∞...</div>
        </div>
    </div>

    <!-- –û–∫–Ω–æ –≤—Ö–æ–¥–∞ -->
    <div class="login-screen" id="loginScreen">
        <div class="login-container">
            <div class="login-header">
                <div class="login-avatar">üí¨</div>
                <h2>Web Messenger</h2>
                <p>–ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –∏ –±—ã—Å—Ç—Ä–æ–µ –æ–±—â–µ–Ω–∏–µ</p>
            </div>
            
            <form class="login-form" id="loginForm">
                <div class="form-group">
                    <label class="form-label" for="username">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                    <input 
                        type="text" 
                        id="username" 
                        class="form-input" 
                        placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è"
                        required
                        autocomplete="username"
                    >
                    <span class="error-message" id="usernameError"></span>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="password">–ü–∞—Ä–æ–ª—å</label>
                    <input 
                        type="password" 
                        id="password" 
                        class="form-input" 
                        placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å"
                        required
                        autocomplete="current-password"
                    >
                    <span class="error-message" id="passwordError"></span>
                </div>
                
                <div class="login-buttons">
                    <button type="submit" class="btn btn-primary" id="loginBtn">
                        –í–æ–π—Ç–∏
                    </button>
                    <button type="button" class="btn btn-secondary" id="registerBtn">
                        –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
                    </button>
                </div>
            </form>
            
            <div class="login-footer">
                –î–ª—è –¥–µ–º–æ-–≤—Ö–æ–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ "demo / demo"
            </div>
        </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–µ –æ–∫–Ω–æ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–∞ -->
    <div class="messenger" id="messenger">
        <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
        <div class="sidebar">
            <!-- –ü—Ä–æ—Ñ–∏–ª—å -->
            <div class="profile-header">
                <div class="profile-avatar" id="userAvatar">üë§</div>
                <div class="profile-info">
                    <div class="profile-name" id="userName">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                    <div class="profile-status">
                        <span class="status-indicator"></span>
                        <span id="userStatus">–æ–Ω–ª–∞–π–Ω</span>
                    </div>
                </div>
            </div>

            <!-- –ü–æ–∏—Å–∫ -->
            <div class="search-container">
                <div class="search-box">
                    <div class="search-icon">üîç</div>
                    <input 
                        type="text" 
                        class="search-input" 
                        id="searchInput"
                        placeholder="–ü–æ–∏—Å–∫ —á–∞—Ç–æ–≤ –∏ —Å–æ–æ–±—â–µ–Ω–∏–π..."
                        autocomplete="off"
                    >
                </div>
            </div>

            <!-- –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ -->
            <div class="chats-list" id="chatsList">
                <!-- –ß–∞—Ç—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                <div class="empty-chat">
                    <div class="empty-chat-icon">üí¨</div>
                    <h3>–ù–µ—Ç —á–∞—Ç–æ–≤</h3>
                    <p>–ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ —Å –∫–µ–º-–Ω–∏–±—É–¥—å</p>
                </div>
            </div>
        </div>

        <!-- –û–∫–Ω–æ —á–∞—Ç–∞ -->
        <div class="chat-window">
            <!-- –®–∞–ø–∫–∞ —á–∞—Ç–∞ -->
            <div class="chat-header-bar">
                <div class="chat-partner-info" id="chatPartnerInfo">
                    <div class="chat-partner-avatar">üë•</div>
                    <div class="chat-partner-details">
                        <h3 id="chatTitle">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</h3>
                        <div class="chat-partner-status">
                            <span class="status-indicator"></span>
                            <span id="chatStatus">–≤—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –¥–ª—è –æ–±—â–µ–Ω–∏—è</span>
                        </div>
                    </div>
                </div>
                
                <div class="chat-actions">
                    <button class="chat-action-btn" title="–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —á–∞—Ç–µ" id="chatInfoBtn">
                        ‚ÑπÔ∏è
                    </button>
                    <button class="chat-action-btn" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏" id="settingsBtn">
                        ‚öôÔ∏è
                    </button>
                </div>
            </div>

            <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
            <div class="messages-area" id="messagesArea">
                <div class="empty-chat">
                    <div class="empty-chat-icon">üí≠</div>
                    <h3>–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</h3>
                    <p>–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –∏–∑ —Å–ø–∏—Å–∫–∞ —Å–ª–µ–≤–∞ –∏–ª–∏ –Ω–∞—á–Ω–∏—Ç–µ –Ω–æ–≤—ã–π –¥–∏–∞–ª–æ–≥</p>
                </div>
            </div>

            <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞–±–æ—Ä–∞ -->
            <div class="typing-indicator" id="typingIndicator"></div>

            <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ -->
            <div class="input-container">
                <div class="input-wrapper">
                    <textarea 
                        class="message-input" 
                        id="messageInput"
                        placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."
                        rows="1"
                        autocomplete="off"
                        disabled
                    ></textarea>
                    <button class="send-button" id="sendButton" disabled>‚û§</button>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
    <div class="modal" id="registerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
                <button class="modal-close" id="closeRegisterModal">√ó</button>
            </div>
            
            <div class="modal-body">
                <form id="registerForm">
                    <div class="form-group">
                        <label class="form-label" for="regUsername">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                        <input 
                            type="text" 
                            id="regUsername" 
                            class="form-input" 
                            placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –∏–º—è"
                            required
                        >
                        <span class="error-message" id="regUsernameError"></span>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="regEmail">Email (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                        <input 
                            type="email" 
                            id="regEmail" 
                            class="form-input" 
                            placeholder="email@example.com"
                        >
                        <span class="error-message" id="regEmailError"></span>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="regPassword">–ü–∞—Ä–æ–ª—å</label>
                        <input 
                            type="password" 
                            id="regPassword" 
                            class="form-input" 
                            placeholder="–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤"
                            required
                        >
                        <span class="error-message" id="regPasswordError"></span>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="regPasswordConfirm">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å</label>
                        <input 
                            type="password" 
                            id="regPasswordConfirm" 
                            class="form-input" 
                            placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å"
                            required
                        >
                        <span class="error-message" id="regPasswordConfirmError"></span>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">–ê–≤–∞—Ç–∞—Ä</label>
                        <div class="avatar-preview">
                            <div class="preview" id="avatarPreview">üë§</div>
                            <input 
                                type="text" 
                                id="regAvatar" 
                                class="form-input avatar-input" 
                                placeholder="–≠–º–æ–¥–∑–∏ –¥–ª—è –∞–≤–∞—Ç–∞—Ä–∞"
                                maxlength="2"
                                value="üë§"
                            >
                        </div>
                    </div>
                </form>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="cancelRegisterBtn">
                    –û—Ç–º–µ–Ω–∞
                </button>
                <button type="button" class="btn btn-primary" id="confirmRegisterBtn">
                    –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
                </button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
                <button class="modal-close" id="closeSettingsModal">√ó</button>
            </div>
            
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">–¢–µ–º–∞</label>
                    <select class="form-input" id="themeSelect">
                        <option value="light">–°–≤–µ—Ç–ª–∞—è</option>
                        <option value="dark" selected>–¢–µ–º–Ω–∞—è</option>
                        <option value="auto">–ê–≤—Ç–æ</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="soundToggle" checked> –ó–≤—É–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
                    </label>
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="notificationToggle" checked> –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                    </label>
                </div>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="saveSettingsBtn">
                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                </button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —á–∞—Ç–µ -->
    <div class="modal" id="chatInfoModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —á–∞—Ç–µ</h2>
                <button class="modal-close" id="closeChatInfoModal">√ó</button>
            </div>
            
            <div class="modal-body" id="chatInfoContent">
                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
        </div>
    </div>

    <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
    <div class="notification hidden" id="notification">
        <div class="notification-icon">!</div>
        <div class="notification-content">
            <div class="notification-title" id="notificationTitle"></div>
            <div class="notification-message" id="notificationMessage"></div>
        </div>
        <button class="notification-close" id="notificationClose">√ó</button>
    </div>

    <script>
        // ============================================
        // –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –û–°–ù–û–í–ù–´–• –ë–ê–ì–û–í –ò –£–õ–£–ß–®–ï–ù–ò–Ø
        // ============================================

        class MessengerApp {
            constructor() {
                // –û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                this.currentUser = null;
                this.activeChat = null;
                this.chats = new Map();
                this.users = new Map();
                this.messages = new Map();
                this.onlineUsers = new Set();
                
                // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
                this.elements = {
                    // –ó–∞–≥—Ä—É–∑—á–∏–∫
                    loader: document.getElementById('loader'),
                    
                    // –í—Ö–æ–¥
                    loginScreen: document.getElementById('loginScreen'),
                    loginForm: document.getElementById('loginForm'),
                    usernameInput: document.getElementById('username'),
                    passwordInput: document.getElementById('password'),
                    loginBtn: document.getElementById('loginBtn'),
                    registerBtn: document.getElementById('registerBtn'),
                    
                    // –ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä
                    messenger: document.getElementById('messenger'),
                    userAvatar: document.getElementById('userAvatar'),
                    userName: document.getElementById('userName'),
                    userStatus: document.getElementById('userStatus'),
                    
                    // –ü–æ–∏—Å–∫
                    searchInput: document.getElementById('searchInput'),
                    
                    // –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤
                    chatsList: document.getElementById('chatsList'),
                    
                    // –û–∫–Ω–æ —á–∞—Ç–∞
                    chatPartnerInfo: document.getElementById('chatPartnerInfo'),
                    chatTitle: document.getElementById('chatTitle'),
                    chatStatus: document.getElementById('chatStatus'),
                    messagesArea: document.getElementById('messagesArea'),
                    typingIndicator: document.getElementById('typingIndicator'),
                    messageInput: document.getElementById('messageInput'),
                    sendButton: document.getElementById('sendButton'),
                    
                    // –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
                    registerModal: document.getElementById('registerModal'),
                    settingsModal: document.getElementById('settingsModal'),
                    chatInfoModal: document.getElementById('chatInfoModal'),
                    
                    // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                    notification: document.getElementById('notification'),
                    notificationTitle: document.getElementById('notificationTitle'),
                    notificationMessage: document.getElementById('notificationMessage'),
                    notificationClose: document.getElementById('notificationClose')
                };
                
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                this.settings = {
                    theme: 'dark',
                    soundEnabled: true,
                    notificationsEnabled: true
                };
                
                // –¢–∞–π–º–µ—Ä—ã
                this.typingTimer = null;
                this.notificationTimer = null;
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
                this.init();
            }
            
            // ============================================
            // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
            // ============================================
            
            init() {
                this.loadSettings();
                this.bindEvents();
                this.checkAuth();
                this.autoResizeTextarea();
            }
            
            bindEvents() {
                // –í—Ö–æ–¥
                this.elements.loginForm.addEventListener('submit', (e) => this.handleLogin(e));
                this.elements.registerBtn.addEventListener('click', () => this.showRegisterModal());
                
                // –ü–æ–∏—Å–∫
                this.elements.searchInput.addEventListener('input', (e) => this.handleSearch(e));
                
                // –°–æ–æ–±—â–µ–Ω–∏—è
                this.elements.messageInput.addEventListener('input', (e) => this.handleTyping(e));
                this.elements.messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });
                this.elements.sendButton.addEventListener('click', () => this.sendMessage());
                
                // –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω—ã
                document.getElementById('closeRegisterModal').addEventListener('click', () => this.hideRegisterModal());
                document.getElementById('cancelRegisterBtn').addEventListener('click', () => this.hideRegisterModal());
                document.getElementById('confirmRegisterBtn').addEventListener('click', () => this.handleRegister());
                
                document.getElementById('settingsBtn').addEventListener('click', () => this.showSettingsModal());
                document.getElementById('closeSettingsModal').addEventListener('click', () => this.hideSettingsModal());
                document.getElementById('saveSettingsBtn').addEventListener('click', () => this.saveSettings());
                
                document.getElementById('chatInfoBtn').addEventListener('click', () => this.showChatInfo());
                document.getElementById('closeChatInfoModal').addEventListener('click', () => this.hideChatInfoModal());
                
                // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                this.elements.notificationClose.addEventListener('click', () => this.hideNotification());
                
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–æ–≤ –≤–Ω–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
                document.addEventListener('click', (e) => {
                    if (e.target.classList.contains('modal')) {
                        this.hideAllModals();
                    }
                });
                
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ Escape
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        this.hideAllModals();
                    }
                });
            }
            
            // ============================================
            // –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø –ò –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø
            // ============================================
            
            checkAuth() {
                const savedUser = localStorage.getItem('messenger_user');
                const savedSession = localStorage.getItem('messenger_session');
                
                if (savedUser && savedSession) {
                    try {
                        const session = JSON.parse(savedSession);
                        if (new Date(session.expires) > new Date()) {
                            this.currentUser = JSON.parse(savedUser);
                            this.setupUserData();
                            this.hideLoader();
                            return;
                        }
                    } catch (e) {
                        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–µ—Å—Å–∏–∏:', e);
                    }
                }
                
                this.showLoginScreen();
            }
            
            async handleLogin(e) {
                e.preventDefault();
                
                const username = this.elements.usernameInput.value.trim();
                const password = this.elements.passwordInput.value;
                
                // –í–∞–ª–∏–¥–∞—Ü–∏—è
                if (!this.validateLogin(username, password)) {
                    return;
                }
                
                // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
                this.elements.loginBtn.disabled = true;
                this.elements.loginBtn.textContent = '–í—Ö–æ–¥...';
                
                // –ò–º–∏—Ç–∞—Ü–∏—è –∑–∞–¥–µ—Ä–∂–∫–∏ —Å–µ—Ç–∏
                await this.sleep(800);
                
                // –î–µ–º–æ-–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
                if (username === 'demo' && password === 'demo') {
                    this.currentUser = this.createDemoUser();
                } else {
                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –±–∞–∑–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                    const users = this.getUsersFromStorage();
                    const user = users.find(u => 
                        u.username.toLowerCase() === username.toLowerCase() && 
                        u.password === password
                    );
                    
                    if (!user) {
                        this.showError('–ù–µ–≤–µ—Ä–Ω–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –ø–∞—Ä–æ–ª—å');
                        this.elements.loginBtn.disabled = false;
                        this.elements.loginBtn.textContent = '–í–æ–π—Ç–∏';
                        return;
                    }
                    
                    this.currentUser = user;
                }
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–µ—Å—Å–∏—é
                this.saveSession();
                this.setupUserData();
                this.hideLoginScreen();
                this.hideLoader();
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
                this.elements.loginBtn.disabled = false;
                this.elements.loginBtn.textContent = '–í–æ–π—Ç–∏';
            }
            
            validateLogin(username, password) {
                let isValid = true;
                
                // –û—á–∏—â–∞–µ–º –æ—à–∏–±–∫–∏
                this.clearErrors();
                
                if (!username) {
                    this.showFieldError('usernameError', '–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                    isValid = false;
                }
                
                if (!password) {
                    this.showFieldError('passwordError', '–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å');
                    isValid = false;
                } else if (password.length < 3) {
                    this.showFieldError('passwordError', '–ü–∞—Ä–æ–ª—å —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π');
                    isValid = false;
                }
                
                return isValid;
            }
            
            showRegisterModal() {
                this.elements.registerModal.classList.add('active');
                document.getElementById('regUsername').focus();
            }
            
            hideRegisterModal() {
                this.elements.registerModal.classList.remove('active');
                this.clearRegisterForm();
            }
            
            async handleRegister() {
                const username = document.getElementById('regUsername').value.trim();
                const email = document.getElementById('regEmail').value.trim();
                const password = document.getElementById('regPassword').value;
                const passwordConfirm = document.getElementById('regPasswordConfirm').value;
                const avatar = document.getElementById('regAvatar').value.trim() || 'üë§';
                
                // –í–∞–ª–∏–¥–∞—Ü–∏—è
                if (!this.validateRegistration(username, email, password, passwordConfirm)) {
                    return;
                }
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const users = this.getUsersFromStorage();
                if (users.some(u => u.username.toLowerCase() === username.toLowerCase())) {
                    this.showFieldError('regUsernameError', '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç');
                    return;
                }
                
                // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const newUser = {
                    id: this.generateId(),
                    username: username,
                    email: email,
                    password: password,
                    avatar: avatar,
                    color: this.getRandomColor(),
                    registered: new Date().toISOString(),
                    lastLogin: new Date().toISOString(),
                    status: 'online',
                    isActive: true
                };
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º
                users.push(newUser);
                localStorage.setItem('messenger_users', JSON.stringify(users));
                
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—Ö–æ–¥
                this.currentUser = newUser;
                this.saveSession();
                this.setupUserData();
                this.hideRegisterModal();
                this.hideLoginScreen();
                this.hideLoader();
                
                this.showNotification('success', '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞', '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä!');
            }
            
            validateRegistration(username, email, password, passwordConfirm) {
                let isValid = true;
                
                // –û—á–∏—â–∞–µ–º –æ—à–∏–±–∫–∏
                document.querySelectorAll('#registerForm .error-message').forEach(el => el.textContent = '');
                
                if (!username) {
                    this.showFieldError('regUsernameError', '–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                    isValid = false;
                } else if (username.length < 3) {
                    this.showFieldError('regUsernameError', '–ú–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞');
                    isValid = false;
                } else if (!/^[a-zA-Z–∞-—è–ê-–Ø0-9_]+$/.test(username)) {
                    this.showFieldError('regUsernameError', '–¢–æ–ª—å–∫–æ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ _');
                    isValid = false;
                }
                
                if (email && !this.isValidEmail(email)) {
                    this.showFieldError('regEmailError', '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç email');
                    isValid = false;
                }
                
                if (!password) {
                    this.showFieldError('regPasswordError', '–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å');
                    isValid = false;
                } else if (password.length < 6) {
                    this.showFieldError('regPasswordError', '–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤');
                    isValid = false;
                }
                
                if (password !== passwordConfirm) {
                    this.showFieldError('regPasswordConfirmError', '–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç');
                    isValid = false;
                }
                
                return isValid;
            }
            
            // ============================================
            // –ù–ê–°–¢–†–û–ô–ö–ò –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø
            // ============================================
            
            setupUserData() {
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                this.elements.userAvatar.textContent = this.currentUser.avatar || 'üë§';
                this.elements.userName.textContent = this.currentUser.username;
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                this.loadChats();
                this.loadUsers();
                
                // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä
                setTimeout(() => {
                    this.elements.messenger.classList.add('loaded');
                }, 100);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –≤—Ö–æ–¥
                this.currentUser.lastLogin = new Date().toISOString();
                this.saveUserData();
            }
            
            showSettingsModal() {
                // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                document.getElementById('themeSelect').value = this.settings.theme;
                document.getElementById('soundToggle').checked = this.settings.soundEnabled;
                document.getElementById('notificationToggle').checked = this.settings.notificationsEnabled;
                
                this.elements.settingsModal.classList.add('active');
            }
            
            hideSettingsModal() {
                this.elements.settingsModal.classList.remove('active');
            }
            
            saveSettings() {
                this.settings = {
                    theme: document.getElementById('themeSelect').value,
                    soundEnabled: document.getElementById('soundToggle').checked,
                    notificationsEnabled: document.getElementById('notificationToggle').checked
                };
                
                localStorage.setItem('messenger_settings', JSON.stringify(this.settings));
                this.applyTheme();
                this.hideSettingsModal();
                
                this.showNotification('success', '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', '–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤—Å—Ç—É–ø—è—Ç –≤ —Å–∏–ª—É');
            }
            
            loadSettings() {
                const saved = localStorage.getItem('messenger_settings');
                if (saved) {
                    this.settings = JSON.parse(saved);
                }
                this.applyTheme();
            }
            
            applyTheme() {
                document.body.setAttribute('data-theme', this.settings.theme);
                
                if (this.settings.theme === 'dark' || 
                    (this.settings.theme === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                    document.documentElement.style.setProperty('--bg-primary', '#0d1117');
                    document.documentElement.style.setProperty('--bg-secondary', '#1a1d21');
                    document.documentElement.style.setProperty('--text-primary', '#ffffff');
                } else {
                    document.documentElement.style.setProperty('--bg-primary', '#ffffff');
                    document.documentElement.style.setProperty('--bg-secondary', '#f7fafc');
                    document.documentElement.style.setProperty('--text-primary', '#2d3748');
                }
            }
            
            // ============================================
            // –†–ê–ë–û–¢–ê –° –ß–ê–¢–ê–ú–ò –ò –°–û–û–ë–©–ï–ù–ò–Ø–ú–ò
            // ============================================
            
            loadChats() {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ localStorage
                const savedChats = localStorage.getItem(`messenger_chats_${this.currentUser.id}`);
                if (savedChats) {
                    const chatsData = JSON.parse(savedChats);
                    this.chats = new Map(chatsData);
                } else {
                    // –°–æ–∑–¥–∞–µ–º –¥–µ–º–æ-—á–∞—Ç—ã
                    this.createDemoChats();
                }
                
                this.renderChatsList();
            }
            
            createDemoChats() {
                const demoUsers = [
                    { id: 'user1', username: '–ê–Ω–Ω–∞', avatar: 'üë©', color: '#e74c3c', status: 'online' },
                    { id: 'user2', username: '–ú–∞–∫—Å–∏–º', avatar: 'üë®', color: '#3498db', status: 'online' },
                    { id: 'user3', username: '–û–ª—å–≥–∞', avatar: 'üë©‚Äçüíº', color: '#9b59b6', status: 'away' },
                    { id: 'user4', username: '–î–º–∏—Ç—Ä–∏–π', avatar: 'üë®‚Äçüíª', color: '#f39c12', status: 'offline' }
                ];
                
                // –û–±—â–∏–π —á–∞—Ç
                const generalChat = {
                    id: 'general',
                    type: 'group',
                    name: '–û–±—â–∏–π —á–∞—Ç',
                    avatar: 'üë•',
                    color: '#667eea',
                    participants: [this.currentUser.id, ...demoUsers.map(u => u.id)],
                    messages: [],
                    unreadCount: 0,
                    lastMessage: null,
                    createdAt: new Date().toISOString()
                };
                
                // –î–µ–º–æ-—Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –æ–±—â–µ–≥–æ —á–∞—Ç–∞
                const demoMessages = [
                    { text: '–ü—Ä–∏–≤–µ—Ç –≤—Å–µ–º! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä!', userId: 'user1' },
                    { text: '–ü—Ä–∏–≤–µ—Ç! –ö–∞–∫ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ?', userId: 'user2' },
                    { text: '–û—Ç–ª–∏—á–Ω–æ! –¢–µ—Å—Ç–∏—Ä—É—é –Ω–æ–≤—ã–π –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä', userId: this.currentUser.id },
                    { text: '–ö—Ä—É—Ç–æ –≤—ã–≥–ª—è–¥–∏—Ç! üëç', userId: 'user3' },
                    { text: '–°–ø–∞—Å–∏–±–æ! –ü–æ–ª—å–∑—É–π—Ç–µ—Å—å –Ω–∞ –∑–¥–æ—Ä–æ–≤—å–µ üòä', userId: this.currentUser.id }
                ];
                
                demoMessages.forEach((msg, index) => {
                    const message = this.createMessage(msg.text, msg.userId, 'general');
                    generalChat.messages.push(message);
                    
                    if (index === demoMessages.length - 1) {
                        generalChat.lastMessage = message;
                    }
                });
                
                this.chats.set('general', generalChat);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –¥–µ–º–æ-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                demoUsers.forEach(user => {
                    this.users.set(user.id, user);
                });
                
                this.saveChats();
            }
            
            renderChatsList() {
                if (this.chats.size === 0) {
                    this.elements.chatsList.innerHTML = `
                        <div class="empty-chat">
                            <div class="empty-chat-icon">üí¨</div>
                            <h3>–ù–µ—Ç —á–∞—Ç–æ–≤</h3>
                            <p>–ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ —Å –∫–µ–º-–Ω–∏–±—É–¥—å</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                
                // –°–æ—Ä—Ç–∏—Ä—É–µ–º —á–∞—Ç—ã –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
                const sortedChats = Array.from(this.chats.values()).sort((a, b) => {
                    const timeA = a.lastMessage ? new Date(a.lastMessage.timestamp) : new Date(a.createdAt);
                    const timeB = b.lastMessage ? new Date(b.lastMessage.timestamp) : new Date(b.createdAt);
                    return timeB - timeA;
                });
                
                sortedChats.forEach(chat => {
                    const isActive = this.activeChat === chat.id;
                    const hasUnread = chat.unreadCount > 0;
                    const lastMessage = chat.lastMessage;
                    
                    let previewText = '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π';
                    let timeText = '';
                    
                    if (lastMessage) {
                        const sender = this.getUserById(lastMessage.senderId);
                        const senderName = sender ? (sender.id === this.currentUser.id ? '–í—ã' : sender.username) : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                        previewText = `${senderName}: ${lastMessage.text}`;
                        timeText = this.formatTime(lastMessage.timestamp);
                    }
                    
                    html += `
                        <div class="chat-item ${isActive ? 'active' : ''} ${hasUnread ? 'unread' : ''}" 
                             data-chat-id="${chat.id}" 
                             onclick="app.selectChat('${chat.id}')">
                            <div class="chat-avatar" style="background: ${chat.color}">
                                ${chat.avatar}
                            </div>
                            <div class="chat-info">
                                <div class="chat-header">
                                    <div class="chat-name">${chat.name}</div>
                                    <div class="chat-time">${timeText}</div>
                                </div>
                                <div class="chat-preview">
                                    <div class="chat-message">${previewText}</div>
                                    ${hasUnread ? `<div class="chat-unread">${chat.unreadCount}</div>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                this.elements.chatsList.innerHTML = html;
            }
            
            selectChat(chatId) {
                if (this.activeChat === chatId) return;
                
                // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ —Å—Ç–∞—Ä–æ–≥–æ —á–∞—Ç–∞
                if (this.activeChat) {
                    const oldChat = this.chats.get(this.activeChat);
                    if (oldChat) {
                        oldChat.unreadCount = 0;
                    }
                }
                
                this.activeChat = chatId;
                const chat = this.chats.get(chatId);
                
                if (!chat) return;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                this.elements.chatTitle.textContent = chat.name;
                this.elements.chatPartnerInfo.querySelector('.chat-partner-avatar').textContent = chat.avatar;
                this.elements.chatPartnerInfo.querySelector('.chat-partner-avatar').style.background = chat.color;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
                if (chat.type === 'group') {
                    this.elements.chatStatus.textContent = `${chat.participants.length} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤`;
                } else {
                    const partnerId = chat.participants.find(id => id !== this.currentUser.id);
                    const partner = this.users.get(partnerId);
                    if (partner) {
                        const status = partner.status === 'online' ? '–æ–Ω–ª–∞–π–Ω' : 
                                      partner.status === 'away' ? '–æ—Ç–æ—à–µ–ª' : '–Ω–µ –≤ —Å–µ—Ç–∏';
                        this.elements.chatStatus.textContent = status;
                    }
                }
                
                // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
                this.elements.messageInput.disabled = false;
                this.elements.sendButton.disabled = false;
                this.elements.messageInput.focus();
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
                this.renderMessages();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤
                this.renderChatsList();
                
                // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤–Ω–∏–∑
                this.scrollToBottom();
            }
            
            renderMessages() {
                if (!this.activeChat) return;
                
                const chat = this.chats.get(this.activeChat);
                if (!chat || chat.messages.length === 0) {
                    this.elements.messagesArea.innerHTML = `
                        <div class="empty-chat">
                            <div class="empty-chat-icon">üí≠</div>
                            <h3>–ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ</h3>
                            <p>–û—Ç–ø—Ä–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —ç—Ç–æ–º —á–∞—Ç–µ</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                let lastDate = null;
                
                chat.messages.forEach(message => {
                    const messageDate = new Date(message.timestamp).toDateString();
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –¥–∞—Ç—ã
                    if (lastDate !== messageDate) {
                        lastDate = messageDate;
                        const dateStr = this.formatDate(message.timestamp);
                        html += `<div class="system-message"><span>${dateStr}</span></div>`;
                    }
                    
                    const isOutgoing = message.senderId === this.currentUser.id;
                    const sender = this.getUserById(message.senderId);
                    const time = this.formatTime(message.timestamp, true);
                    
                    html += `
                        <div class="message ${isOutgoing ? 'outgoing' : 'incoming'}">
                            ${!isOutgoing && sender ? `<div style="font-size: 12px; margin-bottom: 4px; color: rgba(255,255,255,0.7);">${sender.username}</div>` : ''}
                            <div class="message-text">${message.text}</div>
                            <div class="message-time">
                                ${time}
                                ${isOutgoing ? `<span class="message-status ${message.read ? 'read' : ''}">${message.read ? '‚úì‚úì' : '‚úì'}</span>` : ''}
                            </div>
                        </div>
                    `;
                });
                
                this.elements.messagesArea.innerHTML = html;
                this.scrollToBottom();
            }
            
            async sendMessage() {
                if (!this.activeChat) return;
                
                const text = this.elements.messageInput.value.trim();
                if (!text) return;
                
                // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
                this.elements.messageInput.value = '';
                this.autoResizeTextarea();
                
                // –°–æ–∑–¥–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                const message = this.createMessage(text, this.currentUser.id, this.activeChat);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –≤ —á–∞—Ç
                const chat = this.chats.get(this.activeChat);
                chat.messages.push(message);
                chat.lastMessage = message;
                chat.unreadCount = 0;
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º
                this.saveChats();
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º
                this.renderMessages();
                this.renderChatsList();
                
                // –°–∏–º—É–ª–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç –¥–ª—è –¥–µ–º–æ
                if (this.activeChat !== 'general' && Math.random() > 0.3) {
                    await this.sleep(1000 + Math.random() * 2000);
                    this.simulateReply();
                }
            }
            
            simulateReply() {
                if (!this.activeChat) return;
                
                const chat = this.chats.get(this.activeChat);
                if (!chat || chat.type === 'group') return;
                
                // –ù–∞—Ö–æ–¥–∏–º —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞
                const partnerId = chat.participants.find(id => id !== this.currentUser.id);
                const partner = this.users.get(partnerId);
                if (!partner) return;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞–±–æ—Ä–∞
                this.showTyping(partner.username);
                
                // –ñ–¥–µ–º –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç
                setTimeout(() => {
                    const replies = [
                        '–ü—Ä–∏–≤–µ—Ç! –ö–∞–∫ –¥–µ–ª–∞?',
                        '–°–ø–∞—Å–∏–±–æ!',
                        '–ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ...',
                        '–î–∞–≤–∞–π –æ–±—Å—É–¥–∏–º —ç—Ç–æ –ø–æ–∑–∂–µ',
                        '–û—Ç–ª–∏—á–Ω–æ! üëç',
                        '–•–æ—Ä–æ—à–æ, –¥–æ–≥–æ–≤–æ—Ä–∏–ª–∏—Å—å',
                        '–Ø —Ç–æ–∂–µ —Ä–∞–¥ —Ç–µ–±—è –≤–∏–¥–µ—Ç—å',
                        '–°–æ–≥–ª–∞—Å–µ–Ω —Å —Ç–æ–±–æ–π'
                    ];
                    
                    const replyText = replies[Math.floor(Math.random() * replies.length)];
                    const replyMessage = this.createMessage(replyText, partnerId, this.activeChat);
                    
                    chat.messages.push(replyMessage);
                    chat.lastMessage = replyMessage;
                    
                    this.saveChats();
                    this.renderMessages();
                    this.renderChatsList();
                    this.hideTyping();
                    
                }, 1500 + Math.random() * 1000);
            }
            
            createMessage(text, senderId, chatId) {
                return {
                    id: this.generateId(),
                    text: text,
                    senderId: senderId,
                    chatId: chatId,
                    timestamp: new Date().toISOString(),
                    read: false
                };
            }
            
            // ============================================
            // –ü–û–ò–°–ö –ò –§–ò–õ–¨–¢–†–ê–¶–ò–Ø
            // ============================================
            
            handleSearch(e) {
                const query = e.target.value.toLowerCase().trim();
                
                if (!query) {
                    this.renderChatsList();
                    return;
                }
                
                // –§–∏–ª—å—Ç—Ä—É–µ–º —á–∞—Ç—ã
                const filteredChats = Array.from(this.chats.values()).filter(chat => {
                    return chat.name.toLowerCase().includes(query) ||
                           chat.lastMessage?.text.toLowerCase().includes(query);
                });
                
                // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                const filteredUsers = Array.from(this.users.values()).filter(user => {
                    return user.username.toLowerCase().includes(query) &&
                           user.id !== this.currentUser.id;
                });
                
                this.renderSearchResults(filteredChats, filteredUsers, query);
            }
            
            renderSearchResults(chats, users, query) {
                if (chats.length === 0 && users.length === 0) {
                    this.elements.chatsList.innerHTML = `
                        <div class="empty-chat">
                            <div class="empty-chat-icon">üîç</div>
                            <h3>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</h3>
                            <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –∑–∞–ø—Ä–æ—Å</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —á–∞—Ç—ã
                if (chats.length > 0) {
                    html += `<div style="padding: 16px 20px; color: rgba(255,255,255,0.7); font-size: 13px;">–ß–∞—Ç—ã:</div>`;
                    
                    chats.forEach(chat => {
                        const lastMessage = chat.lastMessage;
                        let previewText = '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π';
                        let timeText = '';
                        
                        if (lastMessage) {
                            const sender = this.getUserById(lastMessage.senderId);
                            const senderName = sender ? (sender.id === this.currentUser.id ? '–í—ã' : sender.username) : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                            previewText = `${senderName}: ${lastMessage.text}`;
                            timeText = this.formatTime(lastMessage.timestamp);
                        }
                        
                        html += `
                            <div class="chat-item" data-chat-id="${chat.id}" onclick="app.selectChat('${chat.id}')">
                                <div class="chat-avatar" style="background: ${chat.color}">
                                    ${chat.avatar}
                                </div>
                                <div class="chat-info">
                                    <div class="chat-header">
                                        <div class="chat-name">${chat.name}</div>
                                        <div class="chat-time">${timeText}</div>
                                    </div>
                                    <div class="chat-preview">
                                        <div class="chat-message">${previewText}</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                if (users.length > 0) {
                    html += `<div style="padding: 16px 20px; color: rgba(255,255,255,0.7); font-size: 13px;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:</div>`;
                    
                    users.forEach(user => {
                        html += `
                            <div class="chat-item" onclick="app.startChatWithUser('${user.id}')">
                                <div class="chat-avatar" style="background: ${user.color}">
                                    ${user.avatar}
                                </div>
                                <div class="chat-info">
                                    <div class="chat-header">
                                        <div class="chat-name">${user.username}</div>
                                        <div class="chat-time">${user.status === 'online' ? '–æ–Ω–ª–∞–π–Ω' : '–æ—Ñ–ª–∞–π–Ω'}</div>
                                    </div>
                                    <div class="chat-preview">
                                        <div class="chat-message">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –Ω–∞—á–∞–ª–∞ —á–∞—Ç–∞</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                }
                
                this.elements.chatsList.innerHTML = html;
            }
            
            startChatWithUser(userId) {
                const user = this.users.get(userId);
                if (!user) return;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —á–∞—Ç
                let existingChat = null;
                for (const chat of this.chats.values()) {
                    if (chat.type === 'private' && chat.participants.includes(userId)) {
                        existingChat = chat;
                        break;
                    }
                }
                
                if (existingChat) {
                    this.selectChat(existingChat.id);
                } else {
                    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –ø—Ä–∏–≤–∞—Ç–Ω—ã–π —á–∞—Ç
                    const chatId = `private_${this.currentUser.id}_${userId}`;
                    const newChat = {
                        id: chatId,
                        type: 'private',
                        name: user.username,
                        avatar: user.avatar,
                        color: user.color,
                        participants: [this.currentUser.id, userId],
                        messages: [],
                        unreadCount: 0,
                        lastMessage: null,
                        createdAt: new Date().toISOString()
                    };
                    
                    this.chats.set(chatId, newChat);
                    this.saveChats();
                    this.selectChat(chatId);
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                    const welcomeMessage = this.createMessage(
                        `–ü—Ä–∏–≤–µ—Ç! –Ø —Å–æ–∑–¥–∞–ª —ç—Ç–æ—Ç —á–∞—Ç –¥–ª—è –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ –æ–±—â–µ–Ω–∏—è.`,
                        this.currentUser.id,
                        chatId
                    );
                    
                    newChat.messages.push(welcomeMessage);
                    newChat.lastMessage = welcomeMessage;
                    this.saveChats();
                    this.renderMessages();
                }
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–∏—Å–∫
                this.elements.searchInput.value = '';
                this.renderChatsList();
            }
            
            // ============================================
            // –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –ß–ê–¢–ï
            // ============================================
            
            showChatInfo() {
                if (!this.activeChat) return;
                
                const chat = this.chats.get(this.activeChat);
                if (!chat) return;
                
                let html = '';
                
                if (chat.type === 'group') {
                    html = `
                        <h3 style="margin-bottom: 16px;">${chat.name}</h3>
                        <div style="margin-bottom: 20px;">
                            <div style="color: rgba(255,255,255,0.7); margin-bottom: 8px;">–£—á–∞—Å—Ç–Ω–∏–∫–∏ (${chat.participants.length}):</div>
                            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                ${chat.participants.map(userId => {
                                    const user = this.getUserById(userId);
                                    if (!user) return '';
                                    return `
                                        <div style="display: flex; align-items: center; gap: 8px; background: rgba(0,0,0,0.1); padding: 8px; border-radius: 8px;">
                                            <div style="width: 32px; height: 32px; border-radius: 50%; background: ${user.color}; display: flex; align-items: center; justify-content: center; font-size: 16px;">
                                                ${user.avatar}
                                            </div>
                                            <div>
                                                <div style="font-weight: 500;">${user.username}</div>
                                                <div style="font-size: 12px; color: rgba(255,255,255,0.7);">
                                                    ${user.id === this.currentUser.id ? '–í—ã' : user.status}
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                } else {
                    const partnerId = chat.participants.find(id => id !== this.currentUser.id);
                    const partner = this.users.get(partnerId);
                    
                    if (partner) {
                        html = `
                            <div style="text-align: center; margin-bottom: 24px;">
                                <div style="width: 80px; height: 80px; border-radius: 50%; background: ${partner.color}; display: flex; align-items: center; justify-content: center; font-size: 32px; margin: 0 auto 16px;">
                                    ${partner.avatar}
                                </div>
                                <h3 style="margin-bottom: 8px;">${partner.username}</h3>
                                <div style="color: rgba(255,255,255,0.7);">
                                    –°—Ç–∞—Ç—É—Å: ${partner.status === 'online' ? '–í —Å–µ—Ç–∏' : 
                                            partner.status === 'away' ? '–û—Ç–æ—à–µ–ª' : '–ù–µ –≤ —Å–µ—Ç–∏'}
                                </div>
                            </div>
                            <div style="display: flex; gap: 12px;">
                                <button class="btn btn-primary" style="flex: 1;" onclick="app.clearChatHistory()">
                                    –û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é
                                </button>
                                <button class="btn btn-secondary" style="flex: 1;">
                                    –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
                                </button>
                            </div>
                        `;
                    }
                }
                
                document.getElementById('chatInfoContent').innerHTML = html;
                this.elements.chatInfoModal.classList.add('active');
            }
            
            hideChatInfoModal() {
                this.elements.chatInfoModal.classList.remove('active');
            }
            
            clearChatHistory() {
                if (!this.activeChat) return;
                
                if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π?')) {
                    const chat = this.chats.get(this.activeChat);
                    if (chat) {
                        chat.messages = [];
                        chat.lastMessage = null;
                        this.saveChats();
                        this.renderMessages();
                        this.hideChatInfoModal();
                        this.showNotification('success', '–ò—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–µ–Ω–∞', '–í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω—ã');
                    }
                }
            }
            
            // ============================================
            // –£–¢–ò–õ–ò–¢–´ –ò –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
            // ============================================
            
            showTyping(username) {
                this.elements.typingIndicator.textContent = `${username} –ø–µ—á–∞—Ç–∞–µ—Ç...`;
            }
            
            hideTyping() {
                this.elements.typingIndicator.textContent = '';
            }
            
            handleTyping(e) {
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –≤—ã—Å–æ—Ç—ã —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—è
                this.autoResizeTextarea();
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞–±–æ—Ä–∞ (–¥–ª—è –¥–µ–º–æ)
                if (this.activeChat && this.elements.messageInput.value.trim()) {
                    clearTimeout(this.typingTimer);
                    this.typingTimer = setTimeout(() => {
                        // –°–∏–º—É–ª–∏—Ä—É–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞–±–æ—Ä–∞ —É —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞
                        const chat = this.chats.get(this.activeChat);
                        if (chat && chat.type === 'private') {
                            const partnerId = chat.participants.find(id => id !== this.currentUser.id);
                            const partner = this.users.get(partnerId);
                            if (partner && Math.random() > 0.7) {
                                this.showTyping(partner.username);
                                setTimeout(() => this.hideTyping(), 2000);
                            }
                        }
                    }, 500);
                }
            }
            
            autoResizeTextarea() {
                const textarea = this.elements.messageInput;
                textarea.style.height = 'auto';
                textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
            }
            
            scrollToBottom() {
                setTimeout(() => {
                    const container = this.elements.messagesArea;
                    container.scrollTop = container.scrollHeight;
                }, 100);
            }
            
            showNotification(type, title, message) {
                const notification = this.elements.notification;
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∏–ø –∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
                notification.className = `notification ${type}`;
                notification.querySelector('.notification-icon').textContent = 
                    type === 'success' ? '‚úì' : 
                    type === 'error' ? '‚úó' : '!';
                this.elements.notificationTitle.textContent = title;
                this.elements.notificationMessage.textContent = message;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º
                notification.classList.remove('hidden');
                notification.classList.add('show');
                
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∫—Ä—ã—Ç–∏–µ
                clearTimeout(this.notificationTimer);
                this.notificationTimer = setTimeout(() => {
                    this.hideNotification();
                }, 5000);
            }
            
            hideNotification() {
                const notification = this.elements.notification;
                notification.classList.remove('show');
                setTimeout(() => {
                    notification.classList.add('hidden');
                }, 300);
            }
            
            showError(message) {
                this.showNotification('error', '–û—à–∏–±–∫–∞', message);
            }
            
            showFieldError(fieldId, message) {
                const element = document.getElementById(fieldId);
                if (element) {
                    element.textContent = message;
                }
            }
            
            clearErrors() {
                document.querySelectorAll('.error-message').forEach(el => {
                    el.textContent = '';
                });
            }
            
            clearRegisterForm() {
                document.getElementById('registerForm').reset();
                document.getElementById('avatarPreview').textContent = 'üë§';
                this.clearErrors();
            }
            
            hideAllModals() {
                this.elements.registerModal.classList.remove('active');
                this.elements.settingsModal.classList.remove('active');
                this.elements.chatInfoModal.classList.remove('active');
            }
            
            showLoginScreen() {
                this.elements.loginScreen.style.display = 'flex';
                this.elements.messenger.style.display = 'none';
            }
            
            hideLoginScreen() {
                this.elements.loginScreen.style.display = 'none';
                this.elements.messenger.style.display = 'flex';
            }
            
            showLoader() {
                this.elements.loader.style.display = 'flex';
            }
            
            hideLoader() {
                this.elements.loader.style.opacity = '0';
                setTimeout(() => {
                    this.elements.loader.style.display = 'none';
                }, 300);
            }
            
            // ============================================
            // –†–ê–ë–û–¢–ê –° –î–ê–ù–ù–´–ú–ò
            // ============================================
            
            getUsersFromStorage() {
                const saved = localStorage.getItem('messenger_users');
                return saved ? JSON.parse(saved) : [];
            }
            
            saveUserData() {
                const users = this.getUsersFromStorage();
                const index = users.findIndex(u => u.id === this.currentUser.id);
                
                if (index !== -1) {
                    users[index] = this.currentUser;
                } else {
                    users.push(this.currentUser);
                }
                
                localStorage.setItem('messenger_users', JSON.stringify(users));
            }
            
            saveSession() {
                const session = {
                    userId: this.currentUser.id,
                    token: this.generateToken(),
                    expires: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString()
                };
                
                localStorage.setItem('messenger_session', JSON.stringify(session));
                localStorage.setItem('messenger_user', JSON.stringify(this.currentUser));
            }
            
            saveChats() {
                const chatsArray = Array.from(this.chats.entries());
                localStorage.setItem(`messenger_chats_${this.currentUser.id}`, JSON.stringify(chatsArray));
            }
            
            loadUsers() {
                const users = this.getUsersFromStorage();
                users.forEach(user => {
                    this.users.set(user.id, user);
                });
            }
            
            getUserById(userId) {
                return this.users.get(userId) || null;
            }
            
            createDemoUser() {
                return {
                    id: this.generateId(),
                    username: 'Demo User',
                    email: 'demo@example.com',
                    password: 'demo',
                    avatar: 'üë§',
                    color: this.getRandomColor(),
                    registered: new Date().toISOString(),
                    lastLogin: new Date().toISOString(),
                    status: 'online',
                    isActive: true
                };
            }
            
            // ============================================
            // –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï –ò –í–ê–õ–ò–î–ê–¶–ò–Ø
            // ============================================
            
            formatTime(timestamp, full = false) {
                const date = new Date(timestamp);
                const now = new Date();
                const diff = now - date;
                
                if (diff < 60000) { // –ú–µ–Ω—å—à–µ –º–∏–Ω—É—Ç—ã
                    return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
                } else if (diff < 3600000) { // –ú–µ–Ω—å—à–µ —á–∞—Å–∞
                    const mins = Math.floor(diff / 60000);
                    return `${mins} –º–∏–Ω.`;
                } else if (diff < 86400000) { // –ú–µ–Ω—å—à–µ —Å—É—Ç–æ–∫
                    const hours = Math.floor(diff / 3600000);
                    return `${hours} —á.`;
                } else if (full) {
                    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                } else {
                    return date.toLocaleDateString();
                }
            }
            
            formatDate(timestamp) {
                const date = new Date(timestamp);
                const today = new Date();
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                
                if (date.toDateString() === today.toDateString()) {
                    return '–°–µ–≥–æ–¥–Ω—è';
                } else if (date.toDateString() === yesterday.toDateString()) {
                    return '–í—á–µ—Ä–∞';
                } else {
                    return date.toLocaleDateString('ru-RU', {
                        day: 'numeric',
                        month: 'long'
                    });
                }
            }
            
            isValidEmail(email) {
                const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return re.test(email);
            }
            
            // ============================================
            // –ì–ï–ù–ï–†–ê–¶–ò–Ø –î–ê–ù–ù–´–•
            // ============================================
            
            generateId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2);
            }
            
            generateToken() {
                return 'token_' + Math.random().toString(36).substr(2) + Date.now().toString(36);
            }
            
            getRandomColor() {
                const colors = [
                    '#667eea', '#764ba2', '#f093fb', '#f5576c',
                    '#4facfe', '#00f2fe', '#43e97b', '#38f9d7',
                    '#fa709a', '#fee140', '#30cfd0', '#330867'
                ];
                return colors[Math.floor(Math.random() * colors.length)];
            }
            
            // ============================================
            // –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –ú–ï–¢–û–î–´
            // ============================================
            
            sleep(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        let app;
        document.addEventListener('DOMContentLoaded', () => {
            app = new MessengerApp();
            
            // –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∞–≤–∞—Ç–∞—Ä–∞
            const avatarInput = document.getElementById('regAvatar');
            const avatarPreview = document.getElementById('avatarPreview');
            
            if (avatarInput && avatarPreview) {
                avatarInput.addEventListener('input', function() {
                    avatarPreview.textContent = this.value || 'üë§';
                });
            }
            
            // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ app –¥–ª—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
            window.app = app;
        });
    </script>
</body>
</html>
